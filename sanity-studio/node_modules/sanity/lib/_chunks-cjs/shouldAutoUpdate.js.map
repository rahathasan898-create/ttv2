{"version":3,"file":"shouldAutoUpdate.js","sources":["../../src/_internal/cli/util/readPackageManifest.ts","../../src/_internal/cli/util/compareDependencyVersions.ts","../../src/_internal/cli/util/getAutoUpdatesImportMap.ts","../../src/_internal/cli/util/readModuleVersion.ts","../../src/_internal/cli/util/shouldAutoUpdate.ts"],"sourcesContent":["import {readFile} from 'node:fs/promises'\n\nimport {type PackageJson} from '@sanity/cli'\n\ninterface DependencyDeclarations {\n  dependencies: Record<string, string | undefined>\n  devDependencies: Record<string, string | undefined>\n}\n\ninterface PackageManifest extends DependencyDeclarations {\n  name: string\n  version: string\n}\n\nexport interface PartialPackageManifest extends Partial<DependencyDeclarations> {\n  name: string\n  version: string\n}\n\nfunction isPackageManifest(item: unknown): item is PartialPackageManifest {\n  return typeof item === 'object' && item !== null && 'name' in item && 'version' in item\n}\n\n/**\n * Read the `package.json` file at the given path\n *\n * @param filePath - Path to package.json to read\n * @returns The parsed package.json\n */\nexport async function readPackageJson(filePath: string): Promise<PackageJson> {\n  try {\n    return JSON.parse(await readFile(filePath, 'utf8'))\n  } catch (err) {\n    throw new Error(`Failed to read \"${filePath}\": ${err.message}`)\n  }\n}\n/**\n * Read the `package.json` file at the given path and return an object that guarantees\n * the presence of name, version, dependencies, dev dependencies and peer dependencies\n *\n * @param packageJsonPath - Path to package.json to read\n * @returns Reduced package.json with guarantees for name, version and dependency fields\n */\nexport async function readPackageManifest(\n  packageJsonPath: string,\n  defaults: Partial<PartialPackageManifest> = {},\n): Promise<PackageManifest> {\n  let manifest: unknown\n  try {\n    manifest = {...defaults, ...(await readPackageJson(packageJsonPath))}\n  } catch (err) {\n    throw new Error(`Failed to read \"${packageJsonPath}\": ${err.message}`)\n  }\n\n  if (!isPackageManifest(manifest)) {\n    throw new Error(`Failed to read \"${packageJsonPath}\": Invalid package manifest`)\n  }\n\n  const {name, version, dependencies = {}, devDependencies = {}} = manifest\n  return {name, version, dependencies, devDependencies}\n}\n","import path from 'node:path'\n\nimport resolveFrom from 'resolve-from'\nimport semver from 'semver'\n\nimport {\n  type SanityAppAutoUpdatesImportMap,\n  type StudioAutoUpdatesImportMap,\n} from './getAutoUpdatesImportMap'\nimport {readPackageManifest} from './readPackageManifest'\n\nfunction getRemoteResolvedVersion(fetchFn: typeof fetch, url: string) {\n  return fetchFn(url, {\n    method: 'HEAD',\n    redirect: 'manual',\n  }).then(\n    (res) => {\n      // 302 is expected, but lets also handle 2xx\n      if (res.ok || res.status < 400) {\n        const resolved = res.headers.get('x-resolved-version')\n        if (!resolved) {\n          throw new Error(`Missing 'x-resolved-version' header on response from HEAD ${url}`)\n        }\n        return resolved\n      }\n      throw new Error(`Unexpected HTTP response: ${res.status} ${res.statusText}`)\n    },\n    (err) => {\n      throw new Error(`Failed to fetch remote version for ${url}: ${err.message}`, {cause: err})\n    },\n  )\n}\n\ninterface CompareDependencyVersions {\n  pkg: string\n  installed: string\n  remote: string\n}\n\n/**\n * Compares the versions of dependencies in the studio or app with their remote versions.\n *\n * This function reads the package.json file in the provided working directory, and compares the versions of the dependencies\n * specified in the `autoUpdatesImports` parameter with their remote versions. If the versions do not match, the dependency is\n * added to a list of failed dependencies, which is returned by the function.\n *\n * The failed dependencies are anything that does not strictly match the remote version.\n * This means that if a version is lower or greater by even a patch it will be marked as failed.\n *\n * @param autoUpdatesImports - An object mapping package names to their remote import URLs.\n * @param workDir - The path to the working directory containing the package.json file.\n * @param fetchFn - Optional {@link https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API | Fetch}-compatible function to use for requesting the current remote version of a module\n *\n * @returns A promise that resolves to an array of objects, each containing\n * the name of a package whose local and remote versions do not match, along with the local and remote versions.\n *\n * @throws Throws an error if the remote version of a package cannot be fetched, or if the local version of a package\n * cannot be parsed.\n */\nexport async function compareDependencyVersions(\n  autoUpdatesImports: StudioAutoUpdatesImportMap | SanityAppAutoUpdatesImportMap,\n  workDir: string,\n  fetchFn = globalThis.fetch,\n): Promise<Array<CompareDependencyVersions>> {\n  const manifest = await readPackageManifest(path.join(workDir, 'package.json'))\n  const dependencies = {...manifest.dependencies, ...manifest.devDependencies}\n\n  const failedDependencies: Array<CompareDependencyVersions> = []\n\n  // Filter out the packages that are wildcards in the import map\n  const filteredAutoUpdatesImports = Object.entries(autoUpdatesImports).filter(\n    ([pkg]) => !pkg.endsWith('/'),\n  ) as Array<[string, string]>\n\n  for (const [pkg, value] of filteredAutoUpdatesImports) {\n    const resolvedVersion = await getRemoteResolvedVersion(fetchFn, value)\n\n    const dependency = dependencies[pkg]\n    const manifestPath = resolveFrom.silent(workDir, path.join(pkg, 'package.json'))\n\n    const installed = semver.coerce(\n      manifestPath ? (await readPackageManifest(manifestPath)).version : dependency,\n    )\n\n    if (!installed) {\n      throw new Error(`Failed to parse installed version for ${pkg}`)\n    }\n\n    if (!semver.eq(resolvedVersion, installed.version)) {\n      failedDependencies.push({pkg, installed: installed.version, remote: resolvedVersion})\n    }\n  }\n\n  return failedDependencies\n}\n","/**\n * @internal\n */\nexport interface StudioAutoUpdatesImportMap {\n  'sanity': string\n  'sanity/': string\n  '@sanity/vision'?: string\n  '@sanity/vision/'?: string\n}\n\nexport interface SanityAppAutoUpdatesImportMap extends Partial<StudioAutoUpdatesImportMap> {\n  '@sanity/sdk': string\n  '@sanity/sdk/': string\n  '@sanity/sdk-react': string\n  '@sanity/sdk-react/': string\n}\n\nconst MODULES_HOST =\n  process.env.SANITY_INTERNAL_ENV === 'staging'\n    ? 'https://sanity-cdn.work'\n    : 'https://sanity-cdn.com'\n\nfunction getTimestamp(): string {\n  return `t${Math.floor(Date.now() / 1000)}`\n}\n\n/**\n * @internal\n */\nexport function getStudioAutoUpdateImportMap(\n  version: string,\n  includeVision = true,\n): StudioAutoUpdatesImportMap {\n  const timestamp = getTimestamp()\n\n  const autoUpdatesImports = {\n    'sanity': `${MODULES_HOST}/v1/modules/sanity/default/${version}/${timestamp}`,\n    'sanity/': `${MODULES_HOST}/v1/modules/sanity/default/${version}/${timestamp}/`,\n  }\n\n  if (includeVision) {\n    return {\n      ...autoUpdatesImports,\n      '@sanity/vision': `${MODULES_HOST}/v1/modules/@sanity__vision/default/${version}/${timestamp}`,\n      '@sanity/vision/': `${MODULES_HOST}/v1/modules/@sanity__vision/default/${version}/${timestamp}/`,\n    }\n  }\n\n  return autoUpdatesImports\n}\n\ninterface GetAppAutoUpdateImportMapOptions {\n  sdkVersion: string\n  sanityVersion?: string\n}\n\n/**\n * @internal\n */\nexport function getAppAutoUpdateImportMap(\n  options: GetAppAutoUpdateImportMapOptions,\n): SanityAppAutoUpdatesImportMap {\n  const timestamp = getTimestamp()\n\n  const {sdkVersion, sanityVersion} = options\n\n  const autoUpdatesImports: SanityAppAutoUpdatesImportMap = {\n    '@sanity/sdk': `${MODULES_HOST}/v1/modules/@sanity__sdk/default/${sdkVersion}/${timestamp}`,\n    '@sanity/sdk/': `${MODULES_HOST}/v1/modules/@sanity__sdk/default/${sdkVersion}/${timestamp}/`,\n    '@sanity/sdk-react': `${MODULES_HOST}/v1/modules/@sanity__sdk-react/default/${sdkVersion}/${timestamp}`,\n    '@sanity/sdk-react/': `${MODULES_HOST}/v1/modules/@sanity__sdk-react/default/${sdkVersion}/${timestamp}/`,\n  }\n\n  if (sanityVersion) {\n    const sanityImportMap = getStudioAutoUpdateImportMap(sanityVersion, false)\n    return {...autoUpdatesImports, ...sanityImportMap}\n  }\n\n  return autoUpdatesImports\n}\n","import path from 'node:path'\n\nimport resolveFrom from 'resolve-from'\n\nimport {readPackageManifest} from './readPackageManifest'\n\n/**\n * Reads the version number of the _installed_ module, or returns `null` if not found\n *\n * @param dir - Path of the directory to read the module from\n * @param moduleName - Name of module to get installed version for\n * @returns Version number, of null\n */\nexport async function readModuleVersion(dir: string, moduleName: string): Promise<string | null> {\n  const manifestPath = resolveFrom.silent(dir, path.join(moduleName, 'package.json'))\n  return manifestPath ? (await readPackageManifest(manifestPath)).version : null\n}\n","import {type CliConfig} from '@sanity/cli'\nimport chalk from 'chalk'\n\ninterface AutoUpdateSources {\n  flags: {['auto-updates']?: boolean}\n  cliConfig?: CliConfig\n  output?: {warn: (message: string) => void}\n}\n\n/**\n * Compares parameters from various sources to determine whether or not to auto-update\n * @param sources - The sources of the auto-update parameter, including CLI flags and the CLI config\n * @returns boolean\n * @internal\n */\nexport function shouldAutoUpdate({flags, cliConfig, output}: AutoUpdateSources): boolean {\n  // cli flags (for example, '--no-auto-updates') should take precedence\n  if ('auto-updates' in flags) {\n    if (output) {\n      const flagUsed = flags['auto-updates'] ? '--auto-updates' : '--no-auto-updates'\n      output.warn(\n        chalk.yellow(\n          `The ${flagUsed} flag is deprecated for \\`deploy\\` and \\`build\\` commands. Set the \\`autoUpdates\\` option in \\`sanity.cli.ts\\` or \\`sanity.cli.js\\` instead.`,\n        ),\n      )\n    }\n    return Boolean(flags['auto-updates'])\n  }\n\n  if (cliConfig && 'autoUpdates' in cliConfig) {\n    return Boolean(cliConfig.autoUpdates)\n  }\n\n  return false\n}\n"],"names":["isPackageManifest","item","readPackageJson","filePath","JSON","parse","readFile","err","Error","message","readPackageManifest","packageJsonPath","defaults","manifest","name","version","dependencies","devDependencies","getRemoteResolvedVersion","fetchFn","url","method","redirect","then","res","ok","status","resolved","headers","get","statusText","cause","compareDependencyVersions","autoUpdatesImports","workDir","globalThis","fetch","path","join","failedDependencies","filteredAutoUpdatesImports","Object","entries","filter","pkg","endsWith","value","resolvedVersion","dependency","manifestPath","resolveFrom","silent","installed","semver","coerce","eq","push","remote","MODULES_HOST","process","env","SANITY_INTERNAL_ENV","getTimestamp","Math","floor","Date","now","getStudioAutoUpdateImportMap","includeVision","timestamp","getAppAutoUpdateImportMap","options","sdkVersion","sanityVersion","sanityImportMap","readModuleVersion","dir","moduleName","shouldAutoUpdate","flags","cliConfig","output","flagUsed","warn","chalk","yellow","Boolean","autoUpdates"],"mappings":"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"}